<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å®¶è¨ˆç°¿ éŸ³å£°å…¥åŠ›</title>
  <style>
    * { box-sizing: border-box; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Hiragino Sans', sans-serif;
      max-width: 600px;
      margin: 0 auto;
      padding: 16px;
      background: #f5f5f5;
    }
    
    h1 { text-align: center; color: #333; margin-bottom: 20px; font-size: 24px; }
    
    .card {
      background: white;
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      margin-bottom: 16px;
    }
    
    .input-section { position: relative; }
    
    .voice-input {
      width: 100%;
      padding: 16px;
      font-size: 16px;
      border: 2px solid #4CAF50;
      border-radius: 8px;
      outline: none;
      resize: none;
      min-height: 60px;
      max-height: 200px;
      overflow-y: auto;
      font-family: inherit;
      line-height: 1.5;
    }
    
    .voice-input:focus {
      border-color: #2196F3;
      box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.2);
    }
    
    .clear-text-button {
      margin-top: 8px;
      padding: 8px 16px;
      font-size: 14px;
      background: #eee;
      color: #666;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      display: none;
    }
    .clear-text-button.visible { display: inline-block; }
    .clear-text-button:hover { background: #ddd; }

    .help-toggle-button {
      margin-top: 8px;
      padding: 6px 12px;
      font-size: 13px;
      background: #f5f5f5;
      color: #666;
      border: 1px solid #ddd;
      border-radius: 6px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    .help-toggle-button:hover { background: #e8e8e8; }
    .help-toggle-button .icon { font-size: 14px; }

    .help-section {
      margin-top: 12px;
      display: none;
    }
    .help-section.visible { display: block; }

    .shortcut-hint {
      padding: 10px 12px;
      background: #e3f2fd;
      border-radius: 8px;
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }
    
    .shortcut-hint .icon { font-size: 20px; }
    .shortcut-hint .text { font-size: 13px; color: #1565c0; }
    .shortcut-hint kbd {
      background: #fff;
      padding: 3px 6px;
      border-radius: 4px;
      border: 1px solid #90caf9;
      font-weight: 600;
      font-size: 12px;
    }
    
    .example {
      margin-top: 16px;
      padding: 12px;
      background: #fff3e0;
      border-radius: 8px;
    }
    
    .example h3 { margin: 0 0 8px 0; font-size: 13px; color: #e65100; }
    .example p { margin: 6px 0; font-size: 13px; color: #666; }
    .example code { background: #fff; padding: 2px 6px; border-radius: 4px; font-size: 12px; }
    
    .ai-status {
      margin-top: 12px;
      padding: 10px 16px;
      background: #f3e5f5;
      border-radius: 8px;
      text-align: center;
      font-size: 14px;
      color: #7b1fa2;
      display: none;
    }
    .ai-status.visible { display: block; }
    
    .ai-button {
      margin-top: 12px;
      width: 100%;
      padding: 12px;
      font-size: 16px;
      background: #7c4dff;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }
    .ai-button:hover { background: #651fff; }
    .ai-button:disabled { background: #ccc; cursor: not-allowed; }
    
    .form-group { margin-bottom: 12px; }
    label { display: block; margin-bottom: 4px; font-weight: 500; color: #555; font-size: 14px; }
    input, select {
      width: 100%;
      padding: 10px;
      font-size: 16px;
      border: 1px solid #ddd;
      border-radius: 6px;
    }
    input:focus, select:focus { outline: none; border-color: #4CAF50; }
    
    .tax-breakdown {
      margin-top: 16px;
      padding: 12px;
      background: #e8f5e9;
      border-radius: 8px;
      display: none;
    }
    .tax-breakdown.visible { display: block; }
    .tax-breakdown h3 { margin: 0 0 10px 0; font-size: 13px; color: #2e7d32; }
    .tax-breakdown-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 6px; }
    .tax-breakdown-item { padding: 6px; background: white; border-radius: 4px; text-align: center; }
    .tax-breakdown-item .label { font-size: 10px; color: #666; }
    .tax-breakdown-item .value { font-size: 14px; font-weight: 600; color: #333; }
    
    .submit-button {
      width: 100%;
      padding: 14px;
      font-size: 16px;
      background: #2196F3;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }
    .submit-button:hover { background: #1976D2; }
    .submit-button:disabled { background: #ccc; cursor: not-allowed; }
    
    .status {
      text-align: center;
      padding: 10px;
      border-radius: 6px;
      margin-top: 12px;
      font-size: 14px;
    }
    .status.success { background: #e8f5e9; color: #2e7d32; }
    .status.error { background: #ffebee; color: #c62828; }
    
    .setup-notice {
      background: #fff3cd;
      border: 1px solid #ffc107;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 16px;
    }
    .setup-notice h3 { margin: 0 0 6px 0; color: #856404; font-size: 14px; }
    .setup-notice p { margin: 0; color: #856404; font-size: 13px; }
    
    .history { margin-top: 16px; padding-top: 12px; border-top: 1px solid #eee; }
    .history h3 { margin: 0 0 10px 0; font-size: 13px; color: #666; }
    .history-item {
      padding: 8px 10px;
      background: #f9f9f9;
      border-radius: 6px;
      margin-bottom: 6px;
      font-size: 13px;
      display: flex;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 4px;
    }
    .history-item .time { color: #999; font-size: 11px; }
    
    .cat-detail {
      font-size: 11px;
      color: #666;
      margin-top: 4px;
      padding: 4px 8px;
      background: #f5f5f5;
      border-radius: 4px;
      display: none;
    }
    .cat-detail.visible { display: block; }
    .cat-detail .calc-expr { color: #1976D2; }
    .cat-detail .tax-info { color: #388E3C; margin-top: 2px; }
    
    .api-badge {
      display: inline-block;
      padding: 2px 6px;
      background: #e8f5e9;
      color: #2e7d32;
      border-radius: 4px;
      font-size: 10px;
      margin-left: 6px;
    }
    .api-badge.disabled { background: #f5f5f5; color: #999; }
    
    /* ã‚«ãƒ†ã‚´ãƒªã‚°ãƒªãƒƒãƒ‰ */
    .category-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    
    .category-input-row {
      display: flex;
      gap: 6px;
    }
    
    .category-input-row input {
      flex: 1;
      min-width: 0;
    }
    
    .category-input-row select {
      width: 60px;
      padding: 8px 4px;
      font-size: 12px;
    }
    
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    
    /* ã‚¹ãƒãƒ›å¯¾å¿œ */
    @media (max-width: 480px) {
      body { padding: 12px; }
      
      h1 { font-size: 20px; margin-bottom: 16px; }
      
      .card { padding: 12px; }
      
      .voice-input { padding: 12px; font-size: 16px; }
      
      .shortcut-hint { padding: 8px 10px; }
      .shortcut-hint .text { font-size: 12px; }
      
      .example { padding: 10px; }
      .example p { font-size: 12px; }
      .example code { font-size: 11px; }
      
      .category-grid {
        grid-template-columns: 1fr;
      }
      
      .category-input-row select {
        width: 55px;
      }
      
      .tax-breakdown-grid {
        grid-template-columns: 1fr;
        gap: 4px;
      }
      
      .tax-breakdown-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 12px;
      }
      
      .form-row {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <h1>ğŸ™ï¸ å®¶è¨ˆç°¿ éŸ³å£°å…¥åŠ›</h1>
  
  <div class="setup-notice" id="setupNotice">
    <h3>âš ï¸ åˆå›ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãŒå¿…è¦ã§ã™</h3>
    <p>ä¸‹ã®è¨­å®šæ¬„ã«Google Apps Script URLã¨Claude API Keyã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</p>
  </div>
  
  <div class="card">
    <div class="input-section">
      <textarea 
        class="voice-input" 
        id="voiceInput" 
        placeholder="ã“ã“ã«éŸ³å£°å…¥åŠ›ã—ã¦ãã ã•ã„..."
        rows="3"
      ></textarea>
    </div>
    <button class="clear-text-button" id="clearButton">å…¥åŠ›ã‚’ã‚¯ãƒªã‚¢</button>

    <button class="help-toggle-button" id="helpToggleButton">
      <span class="icon">â“</span>
      <span>ä½¿ã„æ–¹ã‚’è¡¨ç¤º</span>
    </button>

    <div class="help-section" id="helpSection">
      <div class="shortcut-hint">
        <span class="icon">ğŸ¤</span>
        <span class="text">
          å…¥åŠ›æ¬„ã‚’ã‚¯ãƒªãƒƒã‚¯å¾Œã€<kbd>Win + H</kbd>ï¼ˆWindowsï¼‰ã¾ãŸã¯ <kbd>Fn Fn</kbd>ï¼ˆMacï¼‰ã§éŸ³å£°å…¥åŠ›
        </span>
      </div>

      <div class="example">
        <h3>ğŸ’¡ è©±ã—æ–¹ã®ä¾‹</h3>
        <p><code>ã€Œ12æœˆ1æ—¥ ã²ã‚ã¡ é£Ÿè²»1000å†† æ—¥ç”¨å“1500å††ã€</code></p>
        <p><code>ã€Œä»Šæ—¥ å¥ˆæ´¥ç¾ é™¤å¤–8% 100ãŸã™200å†† ãƒ¡ãƒ¢ ã‚¹ãƒ¼ãƒ‘ãƒ¼ã§è³¼å…¥ã€</code></p>
        <p><code>ã€Œæ˜¨æ—¥ æ•¦å­ é£Ÿè²»500å†† æ—¥ç”¨å“300ãŸã™400å†† ã‚³ãƒ³ãƒ“ãƒ‹ã€</code></p>
      </div>
    </div>

    <div class="ai-status" id="aiStatus">ğŸ¤– AIè§£æä¸­...</div>

    <button class="ai-button" id="aiParseButton">ğŸ¤– AIè£œæ­£</button>
  </div>
  
  <div class="card">
    <h2 style="margin-top:0">
      å…¥åŠ›å†…å®¹ã®ç¢ºèª
      <span class="api-badge disabled" id="apiBadge">AIè£œæ­£OFF</span>
    </h2>
    
    <div class="form-row">
      <div class="form-group">
        <label>æ—¥ä»˜</label>
        <input type="date" id="inputDate">
      </div>
      <div class="form-group">
        <label>æ”¯æ‰•è€…</label>
        <select id="inputPayer">
          <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
          <option value="ã²ã‚ã¡">ã²ã‚ã¡</option>
          <option value="å¥ˆæ´¥ç¾">å¥ˆæ´¥ç¾</option>
          <option value="æ•¦å­">æ•¦å­</option>
        </select>
      </div>
    </div>
    
    <div class="form-group">
      <label>ãƒ¡ãƒ¢</label>
      <input type="text" id="inputMemo" placeholder="ä¾‹: ã‚³ãƒ³ãƒ“ãƒ‹ã€ã‚¹ãƒ¼ãƒ‘ãƒ¼ç­‰">
    </div>
    
    <hr style="margin: 16px 0; border: none; border-top: 1px solid #eee;">
    
    <p style="font-size: 12px; color: #666; margin-bottom: 12px;">ã‚«ãƒ†ã‚´ãƒªåˆ¥é‡‘é¡</p>
    <div class="category-grid">
      <div class="form-group" style="margin-bottom: 8px;">
        <label style="font-size: 12px;">æ—¥ç”¨å“ï¼ˆ10%ï¼‰</label>
        <div class="category-input-row">
          <input type="number" id="inputCatæ—¥ç”¨å“" placeholder="0">
          <select id="taxTypeæ—¥ç”¨å“">
            <option value="inclusive">ç¨è¾¼</option>
            <option value="exclusive">ç¨æŠœ</option>
          </select>
        </div>
        <div class="cat-detail" id="detailæ—¥ç”¨å“"></div>
      </div>
      <div class="form-group" style="margin-bottom: 8px;">
        <label style="font-size: 12px;">é™¤å¤–ï¼ˆ8%ï¼‰</label>
        <div class="category-input-row">
          <input type="number" id="inputCaté™¤å¤–8" placeholder="0">
          <select id="taxTypeé™¤å¤–8">
            <option value="inclusive">ç¨è¾¼</option>
            <option value="exclusive">ç¨æŠœ</option>
          </select>
        </div>
        <div class="cat-detail" id="detailé™¤å¤–8"></div>
      </div>
      <div class="form-group" style="margin-bottom: 8px;">
        <label style="font-size: 12px;">é™¤å¤–ï¼ˆ10%ï¼‰</label>
        <div class="category-input-row">
          <input type="number" id="inputCaté™¤å¤–10" placeholder="0">
          <select id="taxTypeé™¤å¤–10">
            <option value="inclusive">ç¨è¾¼</option>
            <option value="exclusive">ç¨æŠœ</option>
          </select>
        </div>
        <div class="cat-detail" id="detailé™¤å¤–10"></div>
      </div>
      <div class="form-group" style="margin-bottom: 8px;">
        <label style="font-size: 12px;">å¤–é£Ÿï¼ˆå®¶æ—å…¨å“¡ï¼‰</label>
        <input type="number" id="inputCatå¤–é£Ÿå…¨å“¡" placeholder="0">
        <div class="cat-detail" id="detailå¤–é£Ÿå…¨å“¡"></div>
      </div>
      <div class="form-group" style="margin-bottom: 8px;">
        <label style="font-size: 12px;">å¤–é£Ÿï¼ˆå®¶æ—ä¸€éƒ¨ï¼‰</label>
        <input type="number" id="inputCatå¤–é£Ÿä¸€éƒ¨" placeholder="0">
        <div class="cat-detail" id="detailå¤–é£Ÿä¸€éƒ¨"></div>
      </div>
    </div>
    
    <div style="margin-top: 16px; padding: 16px; background: #e3f2fd; border-radius: 6px;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
        <label style="font-size: 14px; font-weight: 600; color: #1565c0;">åˆè¨ˆé‡‘é¡</label>
        <div style="display: flex; align-items: center; gap: 8px;">
          <input type="number" id="inputTotal" placeholder="0" style="width: 120px; padding: 10px; font-size: 18px; font-weight: 600; text-align: right; border: 2px solid #1976D2; border-radius: 6px;">
          <span style="font-size: 18px; font-weight: 600;">å††</span>
        </div>
      </div>
      <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: white; border-radius: 6px;">
        <span style="font-size: 14px; color: #666;">â†’ é£Ÿè²»ï¼ˆç¨è¾¼8%ï¼‰</span>
        <span style="font-size: 18px; font-weight: 600; color: #2e7d32;" id="calcShokuhi">0å††</span>
      </div>
      <div class="cat-detail visible" id="detailé£Ÿè²»" style="margin-top: 8px;"></div>
    </div>

    <div class="tax-breakdown" id="taxBreakdown">
      <h3>ğŸ“Š ç¨è¨ˆç®—å†…è¨³</h3>
      <div class="tax-breakdown-grid">
        <div class="tax-breakdown-item">
          <div class="label">ç¨æŠœ</div>
          <div class="value" id="taxExcluded">-</div>
        </div>
        <div class="tax-breakdown-item">
          <div class="label">å¤–ç¨</div>
          <div class="value" id="taxAmount">-</div>
        </div>
        <div class="tax-breakdown-item">
          <div class="label">å°è¨ˆï¼ˆç¨è¾¼ï¼‰</div>
          <div class="value" id="taxTotal">-</div>
        </div>
      </div>
    </div>
    
    <button class="submit-button" id="submitButton" disabled>ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«è¿½è¨˜</button>
    
    <div class="status" id="status" style="display:none"></div>

    <div class="history" id="historySection" style="display:none">
      <h3>ğŸ“ ç›´è¿‘ã®å…¥åŠ›</h3>
      <div id="historyList"></div>
    </div>
  </div>
  
  <div class="card">
    <h2 style="margin-top:0">âš™ï¸ è¨­å®š</h2>
    <div class="form-group">
      <label>Google Apps Script URL</label>
      <input type="text" id="gasUrl" placeholder="https://script.google.com/macros/s/xxxxx/exec">
    </div>
    <div class="form-group">
      <label>Claude API Keyï¼ˆAIè£œæ­£ç”¨ãƒ»ä»»æ„ï¼‰</label>
      <input type="password" id="claudeApiKey" placeholder="sk-ant-api03-xxxxx">
      <p style="font-size: 12px; color: #666; margin-top: 4px;">
        <a href="https://console.anthropic.com/settings/keys" target="_blank">Anthropic Console</a> ã§å–å¾—ï¼ˆ1å›ç´„0.01å††ï¼‰
      </p>
    </div>
    <button class="submit-button" style="background:#666" id="saveSettings">è¨­å®šã‚’ä¿å­˜</button>
  </div>

  <script>
    // ===== è¨­å®šç®¡ç† =====
    const GAS_URL_KEY = 'kakeibo_gas_url';
    const API_KEY_KEY = 'kakeibo_claude_api_key';
    const HISTORY_KEY = 'kakeibo_history';
    
    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ãªã—ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¨­å®šç”»é¢ã§å…¥åŠ›ï¼‰
    
    const TODAY = new Date();
    const CURRENT_YEAR = TODAY.getFullYear();
    
    // ã‚«ãƒ†ã‚´ãƒªåˆ¥ã®è¨ˆç®—å¼ã‚’ä¿æŒ
    let categoryCalcExpr = {
      é£Ÿè²»: null,
      æ—¥ç”¨å“: null,
      å¤–é£Ÿå…¨å“¡: null,
      å¤–é£Ÿä¸€éƒ¨: null,
      é™¤å¤–8: null,
      é™¤å¤–10: null
    };
    
    function loadSettings() {
      const url = localStorage.getItem(GAS_URL_KEY);
      const apiKey = localStorage.getItem(API_KEY_KEY);
      
      if (url) document.getElementById('gasUrl').value = url;
      if (apiKey) document.getElementById('claudeApiKey').value = apiKey;
      
      updateApiBadge();
      
      // GAS URLãŒè¨­å®šã•ã‚Œã¦ã„ãªã„å ´åˆã¯ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—é€šçŸ¥ã‚’è¡¨ç¤º
      if (!url) {
        document.getElementById('setupNotice').style.display = 'block';
      } else {
        document.getElementById('setupNotice').style.display = 'none';
      }
      
      loadHistory();
    }
    
    function saveSettings() {
      const url = document.getElementById('gasUrl').value.trim();
      const apiKey = document.getElementById('claudeApiKey').value.trim();
      
      if (url) localStorage.setItem(GAS_URL_KEY, url);
      if (apiKey) {
        localStorage.setItem(API_KEY_KEY, apiKey);
      } else {
        localStorage.removeItem(API_KEY_KEY);
      }
      
      updateApiBadge();
      
      if (url) document.getElementById('setupNotice').style.display = 'none';
      showStatus('è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ', 'success');
    }
    
    function updateApiBadge() {
      const apiKey = localStorage.getItem(API_KEY_KEY);
      const badge = document.getElementById('apiBadge');
      if (apiKey) {
        badge.textContent = 'AIè£œæ­£ON';
        badge.classList.remove('disabled');
      } else {
        badge.textContent = 'AIè£œæ­£OFF';
        badge.classList.add('disabled');
      }
    }
    
    document.getElementById('saveSettings').addEventListener('click', saveSettings);
    
    // ===== å±¥æ­´ç®¡ç† =====
    function loadHistory() {
      const history = JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]');
      if (history.length > 0) {
        document.getElementById('historySection').style.display = 'block';
        const list = document.getElementById('historyList');
        list.innerHTML = history.slice(0, 5).map(item => `
          <div class="history-item">
            <span>${item.date} ${item.payer} ${item.amount?.toLocaleString()}å††</span>
            <span class="time">${item.time}</span>
          </div>
        `).join('');
      }
    }
    
    function addToHistory(data) {
      const history = JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]');
      history.unshift({
        ...data,
        time: new Date().toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' })
      });
      localStorage.setItem(HISTORY_KEY, JSON.stringify(history.slice(0, 10)));
      loadHistory();
    }
    
    // ===== éŸ³å£°å…¥åŠ›å‡¦ç† =====
    const voiceInput = document.getElementById('voiceInput');
    const clearButton = document.getElementById('clearButton');
    const aiStatus = document.getElementById('aiStatus');
    let debounceTimer = null;
    
    voiceInput.addEventListener('input', () => {
      // è‡ªå‹•ãƒªã‚µã‚¤ã‚º
      voiceInput.style.height = 'auto';
      voiceInput.style.height = voiceInput.scrollHeight + 'px';
      
      clearButton.classList.toggle('visible', voiceInput.value.length > 0);
      
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(() => {
        if (voiceInput.value.trim()) {
          // ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‘ãƒ¼ã‚µãƒ¼ã®ã¿å®Ÿè¡Œ
          const result = parseLocally(voiceInput.value);
          updateFormFromParsed(result);
        } else {
          resetForm();
        }
      }, 300);
    });
    
    clearButton.addEventListener('click', () => {
      voiceInput.value = '';
      voiceInput.style.height = 'auto';
      clearButton.classList.remove('visible');
      resetForm();
      voiceInput.focus();
    });
    
    // AIè£œæ­£ãƒœã‚¿ãƒ³
    document.getElementById('aiParseButton').addEventListener('click', async () => {
      const text = voiceInput.value.trim();
      if (!text) {
        showStatus('éŸ³å£°å…¥åŠ›ã—ã¦ã‹ã‚‰AIè£œæ­£ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„', 'error');
        return;
      }
      
      const apiKey = localStorage.getItem(API_KEY_KEY);
      if (!apiKey) {
        showStatus('Claude API KeyãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
        return;
      }
      
      const result = await parseWithClaudeAPI(text);
      if (result) {
        updateFormFromParsed(result);
        showStatus('âœ¨ AIè£œæ­£å®Œäº†', 'success');
      } else {
        showStatus('AIè£œæ­£ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
      }
    });
    
    // ===== Claude APIé€£æº =====
    async function parseWithClaudeAPI(text) {
      const apiKey = localStorage.getItem(API_KEY_KEY);
      if (!apiKey) return null;
      
      const systemPrompt = `ã‚ãªãŸã¯å®¶è¨ˆç°¿å…¥åŠ›ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚éŸ³å£°å…¥åŠ›ã•ã‚ŒãŸãƒ†ã‚­ã‚¹ãƒˆã‚’è§£æã—ã¦ã€æ§‹é€ åŒ–ã•ã‚ŒãŸJSONã‚’è¿”ã—ã¦ãã ã•ã„ã€‚

ä»Šæ—¥ã®æ—¥ä»˜: ${formatDate(TODAY)}

## æŠ½å‡ºã™ã‚‹é …ç›®
- date: æ—¥ä»˜ï¼ˆYYYY/M/Då½¢å¼ï¼‰ã€‚ã€Œä»Šæ—¥ã€ã€Œæ˜¨æ—¥ã€ã¯å®Ÿéš›ã®æ—¥ä»˜ã«å¤‰æ›ã€‚å¹´ãŒçœç•¥ã•ã‚Œã¦ã„ãŸã‚‰${CURRENT_YEAR}å¹´ã ãŒã€å…¥åŠ›ã•ã‚ŒãŸæœˆãŒç¾åœ¨ã®æœˆï¼ˆ${TODAY.getMonth() + 1}æœˆï¼‰ã‚ˆã‚Šå¤§ãã„å ´åˆã¯å‰å¹´ï¼ˆ${CURRENT_YEAR - 1}å¹´ï¼‰ã¨ã™ã‚‹
- payer: æ”¯æ‰•è€…ï¼ˆã€Œã²ã‚ã¡ã€ã€Œå¥ˆæ´¥ç¾ã€ã€Œæ•¦å­ã€ã®ã„ãšã‚Œã‹ã€‚è¡¨è¨˜ã‚†ã‚Œã‚„èª¤å¤‰æ›ã‚‚è§£é‡ˆã€‚ä¾‹ï¼šå¤§åœ°â†’ã²ã‚ã¡ã€åºƒåœ°â†’ã²ã‚ã¡ï¼‰
- memo: ãƒ¡ãƒ¢ï¼ˆã€Œãƒ¡ãƒ¢ã€ã¨ã„ã†ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒã‚ã£ãŸå ´åˆã¯ãã®å¾Œã®å†…å®¹ã®ã¿ã€‚ãªã„å ´åˆã¯åº—åã‚„ç”¨é€”ãªã©ã€ã‚«ãƒ†ã‚´ãƒªãƒ»é‡‘é¡ä»¥å¤–ã®æƒ…å ±ï¼‰
- amount: åˆè¨ˆé‡‘é¡ï¼ˆè¨€åŠã•ã‚Œã¦ã„ã‚Œã°ï¼‰
- categories: ã‚«ãƒ†ã‚´ãƒªåˆ¥é‡‘é¡ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼ˆè¨ˆç®—å¾Œã®åˆè¨ˆå€¤ï¼‰
- calcExpressions: ã‚«ãƒ†ã‚´ãƒªåˆ¥ã®è¨ˆç®—å¼ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼ˆã€Œ100+200+150ã€ã®ã‚ˆã†ãªå½¢å¼ã€‚è¨ˆç®—ãŒãªã„å ´åˆã¯nullï¼‰

## ã‚«ãƒ†ã‚´ãƒª
- é£Ÿè²»: é£Ÿæ–™å“ã€é£Ÿæãªã©ï¼ˆåˆè¨ˆã‹ã‚‰ä»–ã‚«ãƒ†ã‚´ãƒªã‚’å¼•ã„ãŸæ®‹ã‚Šï¼‰
- æ—¥ç”¨å“: æ—¥ç”¨æ¶ˆè€—å“ï¼ˆ10%ç¨ç‡ï¼‰
- å¤–é£Ÿå…¨å“¡: å®¶æ—å…¨å“¡ã§ã®å¤–é£Ÿ
- å¤–é£Ÿä¸€éƒ¨: å®¶æ—ã®ä¸€éƒ¨ã§ã®å¤–é£Ÿ
- é™¤å¤–8: 8%è»½æ¸›ç¨ç‡ã®é™¤å¤–å“
- é™¤å¤–10: 10%ç¨ç‡ã®é™¤å¤–å“

## é‡‘é¡ã®è¨ˆç®—
ã€Œ100ãŸã™200ã€ã€Œ100+200ã€ã€Œ100ãƒ—ãƒ©ã‚¹200ã€ãªã©ã¯åˆè¨ˆã—ã¦æ•°å€¤ã«ã™ã‚‹ã€‚
è¨ˆç®—å¼ãŒã‚ã‚‹å ´åˆã¯ calcExpressions ã«ã€Œ100+200ã€ã®å½¢å¼ã§è¨˜éŒ²ã™ã‚‹ã€‚

## å‡ºåŠ›å½¢å¼
å¿…ãšä»¥ä¸‹ã®JSONå½¢å¼ã®ã¿ã‚’è¿”ã—ã¦ãã ã•ã„ã€‚èª¬æ˜ã‚„ä½™è¨ˆãªãƒ†ã‚­ã‚¹ãƒˆã¯ä¸è¦ã§ã™ï¼š
{
  "date": "2025/1/12",
  "payer": "ã²ã‚ã¡",
  "memo": "ã‚³ãƒ³ãƒ“ãƒ‹",
  "amount": 1500,
  "categories": {
    "é£Ÿè²»": null,
    "æ—¥ç”¨å“": 500,
    "å¤–é£Ÿå…¨å“¡": null,
    "å¤–é£Ÿä¸€éƒ¨": null,
    "é™¤å¤–8": 450,
    "é™¤å¤–10": null
  },
  "calcExpressions": {
    "é£Ÿè²»": null,
    "æ—¥ç”¨å“": "200+300",
    "å¤–é£Ÿå…¨å“¡": null,
    "å¤–é£Ÿä¸€éƒ¨": null,
    "é™¤å¤–8": "100+200+150",
    "é™¤å¤–10": null
  }
}

é£Ÿè²»ã¯åˆè¨ˆã‹ã‚‰ä»–ã‚«ãƒ†ã‚´ãƒªã‚’å¼•ã„ã¦è¨ˆç®—ã™ã‚‹ãŸã‚ã€æ˜ç¤ºçš„ã«è¨€åŠã•ã‚Œã¦ã„ãªã„é™ã‚Šnullã«ã—ã¦ãã ã•ã„ã€‚
å€¤ãŒãªã„é …ç›®ã¯nullã«ã—ã¦ãã ã•ã„ã€‚`;

      try {
        aiStatus.classList.add('visible');
        
        const response = await fetch('https://api.anthropic.com/v1/messages', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-api-key': apiKey,
            'anthropic-version': '2023-06-01',
            'anthropic-dangerous-direct-browser-access': 'true'
          },
          body: JSON.stringify({
            model: 'claude-sonnet-4-20250514',
            max_tokens: 500,
            system: systemPrompt,
            messages: [{ role: 'user', content: `éŸ³å£°å…¥åŠ›: ã€Œ${text}ã€` }]
          })
        });
        
        aiStatus.classList.remove('visible');
        
        if (!response.ok) {
          console.error('Claude API error:', response.status);
          return null;
        }
        
        const data = await response.json();
        const content = data.content[0].text;
        
        const jsonMatch = content.match(/\{[\s\S]*\}/);
        if (jsonMatch) {
          const parsed = JSON.parse(jsonMatch[0]);
          // è¨ˆç®—å¼ã‚’ä¿å­˜
          if (parsed.calcExpressions) {
            categoryCalcExpr = { ...categoryCalcExpr, ...parsed.calcExpressions };
          }
          return parsed;
        }
      } catch (error) {
        aiStatus.classList.remove('visible');
        console.error('Claude API error:', error);
      }
      
      return null;
    }
    
    // parseWithClaudeAPIã¯ãã®ã¾ã¾ä½¿ç”¨
    
    // ===== ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‘ãƒ¼ã‚µãƒ¼ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰ =====
    function parseLocally(text) {
      let normalized = text.replace(/\s+/g, ' ').replace(/ã€/g, ' ').replace(/ã€‚/g, '').trim();
      
      const result = {
        date: null,
        payer: null,
        memo: null,
        categories: { é£Ÿè²»: null, æ—¥ç”¨å“: null, å¤–é£Ÿå…¨å“¡: null, å¤–é£Ÿä¸€éƒ¨: null, é™¤å¤–8: null, é™¤å¤–10: null }
      };
      
      // æ—¥ä»˜
      if (/ä»Šæ—¥|ãã‚‡ã†/.test(normalized)) {
        result.date = formatDate(TODAY);
        normalized = normalized.replace(/ä»Šæ—¥|ãã‚‡ã†/g, '');
      } else if (/æ˜¨æ—¥|ãã®ã†/.test(normalized)) {
        const yesterday = new Date(TODAY);
        yesterday.setDate(yesterday.getDate() - 1);
        result.date = formatDate(yesterday);
        normalized = normalized.replace(/æ˜¨æ—¥|ãã®ã†/g, '');
      } else {
        const m = normalized.match(/(\d{1,2})æœˆ(\d{1,2})æ—¥?/);
        if (m) {
          const month = parseInt(m[1]);
          const day = parseInt(m[2]);
          const currentMonth = TODAY.getMonth() + 1; // 0-indexed ãªã®ã§ +1
          // å…¥åŠ›ã•ã‚ŒãŸæœˆãŒç¾åœ¨ã®æœˆã‚ˆã‚Šå¤§ãã„å ´åˆã¯å‰å¹´ã¨ã™ã‚‹
          const year = month > currentMonth ? CURRENT_YEAR - 1 : CURRENT_YEAR;
          result.date = `${year}/${month}/${day}`;
          normalized = normalized.replace(m[0], '');
        }
      }
      
      // æ”¯æ‰•è€…
      const payerPatterns = [
        { patterns: ['ã²ã‚ã¡', 'ãƒ’ãƒ­ãƒ', 'åºƒåœ°', 'å¼˜åœ°', 'å¤§åœ°', 'hirochi'], value: 'ã²ã‚ã¡' },
        { patterns: ['å¥ˆæ´¥ç¾', 'ãªã¤ã¿', 'ãƒŠãƒ„ãƒŸ', 'å¤ç¾', 'èœæ‘˜', 'å¥ˆéƒ½ç¾', 'natsumi'], value: 'å¥ˆæ´¥ç¾' },
        { patterns: ['æ•¦å­', 'ã‚ã¤ã“', 'ã‚¢ãƒ„ã‚³', 'åšå­', 'æ·³å­', 'ç¯¤å­', 'atsuko'], value: 'æ•¦å­' }
      ];
      
      for (const { patterns, value } of payerPatterns) {
        for (const p of patterns) {
          if (normalized.includes(p)) {
            result.payer = value;
            normalized = normalized.replace(new RegExp(p, 'g'), '');
            break;
          }
        }
        if (result.payer) break;
      }
      
      // ã‚«ãƒ†ã‚´ãƒª+é‡‘é¡
      const categoryPatterns = [
        { keywords: ['å¤–é£Ÿå…¨å“¡', 'å¤–é£Ÿ å…¨å“¡', 'å®¶æ—å…¨å“¡', 'ãŒã„ã—ã‚‡ããœã‚“ã„ã‚“'], value: 'å¤–é£Ÿå…¨å“¡' },
        { keywords: ['å¤–é£Ÿä¸€éƒ¨', 'å¤–é£Ÿ ä¸€éƒ¨', 'å®¶æ—ä¸€éƒ¨', 'ãŒã„ã—ã‚‡ãã„ã¡ã¶'], value: 'å¤–é£Ÿä¸€éƒ¨' },
        { keywords: ['æ—¥ç”¨å“', 'æ—¥ç”¨', 'ã«ã¡ã‚ˆã†ã²ã‚“', 'æ—¥æ›œå“'], value: 'æ—¥ç”¨å“' },
        { keywords: ['é™¤å¤–8', 'é™¤å¤– 8', '8%', '8ãƒ‘ãƒ¼ã‚»ãƒ³ãƒˆ', 'ã˜ã‚‡ãŒã„8', 'å¥³å¤–8'], value: 'é™¤å¤–8' },
        { keywords: ['é™¤å¤–10', 'é™¤å¤– 10', '10%', '10ãƒ‘ãƒ¼ã‚»ãƒ³ãƒˆ', 'ã˜ã‚‡ãŒã„10', 'å¥³å¤–10'], value: 'é™¤å¤–10' },
        { keywords: ['é£Ÿè²»', 'é£Ÿäº‹', 'ã—ã‚‡ãã²', 'é£Ÿæ—¥'], value: 'é£Ÿè²»' },
      ];
      
      // è¨ˆç®—å¼ã‚’ãƒªã‚»ãƒƒãƒˆ
      categoryCalcExpr = { é£Ÿè²»: null, æ—¥ç”¨å“: null, å¤–é£Ÿå…¨å“¡: null, å¤–é£Ÿä¸€éƒ¨: null, é™¤å¤–8: null, é™¤å¤–10: null };
      
      for (const cat of categoryPatterns) {
        for (const kw of cat.keywords) {
          const calcPattern = '([\\d,]+(?:\\s*(?:ãŸã™|ã‚¿ã‚¹|è¶³ã™|ãƒ—ãƒ©ã‚¹|ã·ã‚‰ã™|\\+)\\s*[\\d,]+)*)';
          const patterns = [
            new RegExp(kw + '\\s*' + calcPattern + '\\s*å††?', 'i'),
            new RegExp(calcPattern + '\\s*å††?\\s*' + kw, 'i')
          ];
          
          for (const pattern of patterns) {
            const match = normalized.match(pattern);
            if (match) {
              const rawExpr = match[1];
              const { amount, expression } = evaluateCalcWithExpr(rawExpr);
              if (amount > 0) {
                result.categories[cat.value] = amount;
                categoryCalcExpr[cat.value] = expression;
                normalized = normalized.replace(match[0], '');
              }
              break;
            }
          }
          if (result.categories[cat.value]) break;
        }
      }
      
      // ãƒ¡ãƒ¢ã‚’æŠ½å‡º
      // ã€Œãƒ¡ãƒ¢ã€ã¨ã„ã†ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒã‚ã‚Œã°ãã®å¾Œã®å†…å®¹ã®ã¿ã‚’ãƒ¡ãƒ¢ã¨ã™ã‚‹
      const memoMatch = normalized.match(/(?:ãƒ¡ãƒ¢|ã‚ã‚‚)\s*(.+)/i);
      if (memoMatch) {
        result.memo = memoMatch[1].trim();
      } else {
        // ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒãªã„å ´åˆã¯æ®‹ã‚Šã®å†…å®¹ã‚’ãƒ¡ãƒ¢ã«
        const memo = normalized.replace(/\s+/g, ' ').trim();
        if (memo) result.memo = memo;
      }

      return result;
    }
    
    function formatDate(d) {
      return `${d.getFullYear()}/${d.getMonth() + 1}/${d.getDate()}`;
    }
    
    function evaluateCalcWithExpr(text) {
      let expr = text.replace(/ãŸã™|ã‚¿ã‚¹|è¶³ã™|ãƒ—ãƒ©ã‚¹|ã·ã‚‰ã™/g, '+').replace(/\s+/g, '').replace(/,/g, '');
      
      // å˜ä¸€ã®æ•°å€¤ã®å ´åˆ
      if (/^\d+$/.test(expr)) {
        return { amount: parseInt(expr), expression: null };
      }
      
      // è¨ˆç®—å¼ãŒã‚ã‚‹å ´åˆ
      if (/^[\d+]+$/.test(expr)) {
        const parts = expr.split('+').filter(n => n);
        const amount = parts.reduce((sum, n) => sum + (parseInt(n) || 0), 0);
        return { amount, expression: parts.length > 1 ? parts.join('+') : null };
      }
      
      return { amount: parseInt(expr.replace(/\D/g, '')) || 0, expression: null };
    }
    
    function evaluateCalc(text) {
      return evaluateCalcWithExpr(text).amount;
    }
    
    function updateFormFromParsed(data) {
      if (data.date) {
        const parts = data.date.split('/');
        document.getElementById('inputDate').value = `${parts[0]}-${parts[1].padStart(2,'0')}-${parts[2].padStart(2,'0')}`;
      }
      if (data.payer) document.getElementById('inputPayer').value = data.payer;
      if (data.memo) document.getElementById('inputMemo').value = data.memo;
      
      // åˆè¨ˆé‡‘é¡ã‚’è¨­å®š
      if (data.amount) {
        document.getElementById('inputTotal').value = data.amount;
      } else if (data.categories) {
        // ã‚«ãƒ†ã‚´ãƒªã‹ã‚‰åˆè¨ˆã‚’è¨ˆç®—
        let total = 0;
        for (const [cat, val] of Object.entries(data.categories)) {
          if (val) total += val;
        }
        if (total > 0) document.getElementById('inputTotal').value = total;
      }
      
      // å„ã‚«ãƒ†ã‚´ãƒªï¼ˆé£Ÿè²»ä»¥å¤–ï¼‰
      for (const cat of ['æ—¥ç”¨å“', 'å¤–é£Ÿå…¨å“¡', 'å¤–é£Ÿä¸€éƒ¨', 'é™¤å¤–8', 'é™¤å¤–10']) {
        const input = document.getElementById('inputCat' + cat);
        if (input) input.value = data.categories?.[cat] || '';
      }
      
      updateTotals();
      validateForm();
    }
    
    // ===== ãƒ•ã‚©ãƒ¼ãƒ åŒæœŸ =====
    const formInputs = ['inputDate', 'inputPayer', 'inputMemo', 'inputTotal', 'inputCatæ—¥ç”¨å“', 'inputCatå¤–é£Ÿå…¨å“¡', 'inputCatå¤–é£Ÿä¸€éƒ¨', 'inputCaté™¤å¤–8', 'inputCaté™¤å¤–10', 'taxTypeæ—¥ç”¨å“', 'taxTypeé™¤å¤–8', 'taxTypeé™¤å¤–10'];
    formInputs.forEach(id => {
      const el = document.getElementById(id);
      if (el) {
        el.addEventListener('input', () => { updateTotals(); validateForm(); });
        el.addEventListener('change', () => { updateTotals(); validateForm(); });
      }
    });
    
    function updateTotals() {
      const total = parseInt(document.getElementById('inputTotal').value) || 0;
      
      // ç¨ç‡è¨­å®š
      const taxRates = { æ—¥ç”¨å“: 0.10, é™¤å¤–8: 0.08, é™¤å¤–10: 0.10 };
      let otherCatsTotal = 0;
      let taxExcluded = 0, taxAmount = 0, taxTotal = 0;
      
      // å„ã‚«ãƒ†ã‚´ãƒªã®è©³ç´°ã‚’æ›´æ–°ï¼ˆé£Ÿè²»ä»¥å¤–ï¼‰
      for (const cat of ['æ—¥ç”¨å“', 'é™¤å¤–8', 'é™¤å¤–10', 'å¤–é£Ÿå…¨å“¡', 'å¤–é£Ÿä¸€éƒ¨']) {
        const amount = parseInt(document.getElementById('inputCat' + cat).value) || 0;
        const detailEl = document.getElementById('detail' + cat);
        
        if (amount > 0) {
          let detailHtml = '';
          
          // è¨ˆç®—å¼ãŒã‚ã‚‹å ´åˆ
          const expr = categoryCalcExpr[cat];
          if (expr) {
            detailHtml += `<div class="calc-expr">è¨ˆç®—: ${expr} = ${amount.toLocaleString()}</div>`;
          }
          
          // ç¨è¨ˆç®—ãŒã‚ã‚‹å ´åˆ
          if (taxRates[cat]) {
            const rate = taxRates[cat];
            const taxTypeEl = document.getElementById('taxType' + cat);
            const isExclusive = taxTypeEl && taxTypeEl.value === 'exclusive';
            
            let ex, tax, inclusive;
            if (isExclusive) {
              ex = amount;
              tax = Math.round(amount * rate);
              inclusive = amount + tax;
            } else {
              inclusive = amount;
              ex = Math.round(amount / (1 + rate));
              tax = amount - ex;
            }
            
            taxExcluded += ex;
            taxAmount += tax;
            taxTotal += inclusive;
            otherCatsTotal += inclusive;
            
            detailHtml += `<div class="tax-info">ç¨æŠœ ${ex.toLocaleString()}å†† + å¤–ç¨ ${tax.toLocaleString()}å†† = ${inclusive.toLocaleString()}å††</div>`;
          } else {
            otherCatsTotal += amount;
          }
          
          if (detailHtml) {
            detailEl.innerHTML = detailHtml;
            detailEl.classList.add('visible');
          } else {
            detailEl.classList.remove('visible');
          }
        } else {
          detailEl.classList.remove('visible');
        }
      }
      
      // é£Ÿè²» = åˆè¨ˆ - ãã®ä»–ã‚«ãƒ†ã‚´ãƒª
      const shokuhi = Math.max(0, total - otherCatsTotal);
      document.getElementById('calcShokuhi').textContent = shokuhi.toLocaleString() + 'å††';
      
      // é£Ÿè²»ã®å†…è¨³ï¼ˆ8%ç¨è¾¼ã¨ã—ã¦è¨ˆç®—ï¼‰
      const detailShokuhi = document.getElementById('detailé£Ÿè²»');
      if (shokuhi > 0) {
        const shokuhiEx = Math.round(shokuhi / 1.08);
        const shokuhiTax = shokuhi - shokuhiEx;
        detailShokuhi.innerHTML = `<div class="tax-info">ç¨æŠœ ${shokuhiEx.toLocaleString()}å†† + å¤–ç¨ ${shokuhiTax.toLocaleString()}å††</div>`;
        detailShokuhi.classList.add('visible');
      } else {
        detailShokuhi.classList.remove('visible');
      }
      
      const breakdown = document.getElementById('taxBreakdown');
      if (taxTotal > 0) {
        breakdown.classList.add('visible');
        document.getElementById('taxExcluded').textContent = taxExcluded.toLocaleString() + 'å††';
        document.getElementById('taxAmount').textContent = taxAmount.toLocaleString() + 'å††';
        document.getElementById('taxTotal').textContent = taxTotal.toLocaleString() + 'å††';
      } else {
        breakdown.classList.remove('visible');
      }
    }
    
    function validateForm() {
      const date = document.getElementById('inputDate').value;
      const payer = document.getElementById('inputPayer').value;
      const total = parseInt(document.getElementById('inputTotal').value) || 0;
      
      document.getElementById('submitButton').disabled = !(date && payer && total > 0);
    }
    
    function resetForm() {
      document.getElementById('inputDate').value = '';
      document.getElementById('inputPayer').value = '';
      document.getElementById('inputMemo').value = '';
      document.getElementById('inputTotal').value = '';
      ['æ—¥ç”¨å“', 'å¤–é£Ÿå…¨å“¡', 'å¤–é£Ÿä¸€éƒ¨', 'é™¤å¤–8', 'é™¤å¤–10'].forEach(cat => {
        document.getElementById('inputCat' + cat).value = '';
        document.getElementById('detail' + cat).classList.remove('visible');
      });
      document.getElementById('detailé£Ÿè²»').classList.remove('visible');
      document.getElementById('calcShokuhi').textContent = '0å††';
      // ç¨ã‚¿ã‚¤ãƒ—ã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: ç¨è¾¼ï¼‰
      ['æ—¥ç”¨å“', 'é™¤å¤–8', 'é™¤å¤–10'].forEach(cat => {
        document.getElementById('taxType' + cat).value = 'inclusive';
      });
      // è¨ˆç®—å¼ã‚’ãƒªã‚»ãƒƒãƒˆ
      categoryCalcExpr = { é£Ÿè²»: null, æ—¥ç”¨å“: null, å¤–é£Ÿå…¨å“¡: null, å¤–é£Ÿä¸€éƒ¨: null, é™¤å¤–8: null, é™¤å¤–10: null };
      document.getElementById('taxBreakdown').classList.remove('visible');
      document.getElementById('submitButton').disabled = true;
    }
    
    // ===== é€ä¿¡ =====
    document.getElementById('submitButton').addEventListener('click', submitData);
    
    async function submitData() {
      const gasUrl = localStorage.getItem(GAS_URL_KEY);
      if (!gasUrl) {
        showStatus('Google Apps Script URLã‚’è¨­å®šã—ã¦ãã ã•ã„', 'error');
        return;
      }
      
      const dateVal = document.getElementById('inputDate').value;
      const d = new Date(dateVal);
      const formattedDate = `${d.getFullYear()}/${d.getMonth() + 1}/${d.getDate()}`;
      
      const total = parseInt(document.getElementById('inputTotal').value) || 0;
      const taxRates = { æ—¥ç”¨å“: 0.10, é™¤å¤–8: 0.08, é™¤å¤–10: 0.10 };
      const categories = {};
      let otherCatsTotal = 0;
      
      for (const cat of ['æ—¥ç”¨å“', 'å¤–é£Ÿå…¨å“¡', 'å¤–é£Ÿä¸€éƒ¨', 'é™¤å¤–8', 'é™¤å¤–10']) {
        const val = parseInt(document.getElementById('inputCat' + cat).value) || null;
        
        if (val && taxRates[cat]) {
          const taxTypeEl = document.getElementById('taxType' + cat);
          const isExclusive = taxTypeEl && taxTypeEl.value === 'exclusive';
          
          if (isExclusive) {
            const tax = Math.round(val * taxRates[cat]);
            categories[cat] = val + tax;
          } else {
            categories[cat] = val;
          }
        } else {
          categories[cat] = val;
        }
        
        if (categories[cat]) otherCatsTotal += categories[cat];
      }
      
      // é£Ÿè²» = åˆè¨ˆ - ãã®ä»–ã‚«ãƒ†ã‚´ãƒª
      categories['é£Ÿè²»'] = Math.max(0, total - otherCatsTotal);
      
      const data = {
        date: formattedDate,
        payer: document.getElementById('inputPayer').value,
        memo: document.getElementById('inputMemo').value || null,
        amount: total,
        categories: categories
      };
      
      const btn = document.getElementById('submitButton');
      btn.disabled = true;
      btn.textContent = 'é€ä¿¡ä¸­...';
      
      try {
        // GETãƒªã‚¯ã‚¨ã‚¹ãƒˆã§ãƒ‡ãƒ¼ã‚¿ã‚’é€ä¿¡ï¼ˆã‚¹ãƒãƒ›å¯¾å¿œï¼‰
        const params = new URLSearchParams({
          data: JSON.stringify(data)
        });
        const url = `${gasUrl}?${params.toString()}`;
        
        const response = await fetch(url, {
          method: 'GET',
          mode: 'cors',
          redirect: 'follow'
        });
        
        if (response.ok) {
          const result = await response.json();
          if (result.success) {
            showStatus('âœ… ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«è¿½è¨˜ã—ã¾ã—ãŸï¼', 'success');
            addToHistory(data);
            
            voiceInput.value = '';
            voiceInput.style.height = 'auto';
            clearButton.classList.remove('visible');
            resetForm();
            voiceInput.focus();
          } else {
            showStatus('ã‚¨ãƒ©ãƒ¼: ' + (result.error || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'), 'error');
          }
        } else {
          throw new Error('ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼');
        }
      } catch (error) {
        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: no-corsãƒ¢ãƒ¼ãƒ‰ï¼ˆæˆåŠŸç¢ºèªã¯ã§ããªã„ãŒãƒªã‚¯ã‚¨ã‚¹ãƒˆã¯é€ã‚‹ï¼‰
        try {
          const params = new URLSearchParams({
            data: JSON.stringify(data)
          });
          await fetch(`${gasUrl}?${params.toString()}`, {
            method: 'GET',
            mode: 'no-cors'
          });
          
          showStatus('âœ… é€ä¿¡ã—ã¾ã—ãŸï¼ˆç¢ºèªä¸å¯ï¼‰', 'success');
          addToHistory(data);
          
          voiceInput.value = '';
          voiceInput.style.height = 'auto';
          clearButton.classList.remove('visible');
          resetForm();
          voiceInput.focus();
        } catch (e) {
          showStatus('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message, 'error');
        }
      }
      
      btn.disabled = false;
      btn.textContent = 'ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«è¿½è¨˜';
    }
    
    function showStatus(message, type) {
      const status = document.getElementById('status');
      status.textContent = message;
      status.className = 'status ' + type;
      status.style.display = 'block';
      setTimeout(() => { status.style.display = 'none'; }, 3000);
    }

    // ===== ãƒ˜ãƒ«ãƒ—ã‚»ã‚¯ã‚·ãƒ§ãƒ³é–‹é–‰ =====
    const helpToggleButton = document.getElementById('helpToggleButton');
    const helpSection = document.getElementById('helpSection');

    helpToggleButton.addEventListener('click', () => {
      const isVisible = helpSection.classList.toggle('visible');
      helpToggleButton.querySelector('span:last-child').textContent =
        isVisible ? 'ä½¿ã„æ–¹ã‚’éè¡¨ç¤º' : 'ä½¿ã„æ–¹ã‚’è¡¨ç¤º';
    });

    // ===== åˆæœŸåŒ– =====
    loadSettings();
    voiceInput.focus();
  </script>
</body>
</html>
